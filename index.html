<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>脳トレまちがいさがし</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Yomogi&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
  
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel (for JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    // Firestoreのデバッグレベルを設定
    setLogLevel('silent'); 
    
    // --- グローバル設定 ---
    const ADMIN_PASSWORD = "admin"; // 管理者モードのパスワード
    
    // **お客様提供のFirebase設定**
    const appId = 'machigaisagashi-fdc81'; // Firestoreのデータパスに使用
    const firebaseConfig = {
      apiKey: "AIzaSyCEsnt2_5MY7ATFsPVcYB5_lUGNOP-6Nz8",
      authDomain: "machigaisagashi-fdc81.firebaseapp.com",
      projectId: "machigaisagashi-fdc81",
      storageBucket: "machigaisagashi-fdc81.firebasestorage.app",
      messagingSenderId: "198107594424",
      appId: "1:198107594424:web:76b0da74a17923f0833e4d",
      measurementId: "G-K392B89CXK"
    };

    // Firebase初期化
    let db, auth;
    window.isFirebaseInitialized = false;

    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      window.isFirebaseInitialized = true;
    } catch (e) {
      console.error("Firebase Init Error:", e);
    }

    // Expose to window
    window.db = db;
    window.auth = auth;
    window.AuthFunctions = { signInAnonymously, signInWithCustomToken };
    window.Firestore = { collection, getDocs, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp };
  </script>

  <style>
    body {
      font-family: 'Zen Maru Gothic', sans-serif;
    }
    .font-hand { font-family: 'Yomogi', cursive; }
    .bg-grid-pattern {
      background-image: linear-gradient(#e5e7eb 1px, transparent 1px),
                        linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
      background-size: 20px 20px;
    }
    .pop-shadow {
      box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.1);
    }
    .pop-shadow-hover:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0px 0px rgba(0,0,0,0.15);
    }
    .pop-shadow-active:active {
      transform: translate(2px, 2px);
      box-shadow: 0px 0px 0px 0px rgba(0,0,0,0.1);
    }
    .text-shadow-pop {
      text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
    }
    /* Animation Utilities */
    .animate-bounce-slow { animation: bounce 3s infinite; }
    .animate-spin-slow { animation: spin 8s linear infinite; }
    .animate-ping-once { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) 1; }
    .animate-bounce-short { animation: bounce 0.5s 2; }
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    .animate-scale-in { animation: scaleIn 0.3s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body class="bg-[#F9FAFB]">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- 設定値 ---
    const appId = 'machigaisagashi-fdc81'; 
    const ADMIN_PASSWORD = "admin9876"; 

    // --- Icons Definitions ---
    const Icons = {
      Trash2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
      Plus: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
      Play: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
      Edit3: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>,
      X: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
      CheckCircle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
      MousePointer2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 15-4 5H4l5-5"/><path d="m2 2 20 8-10 2-2 10Z"/></svg>,
      ArrowLeft: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
      RotateCcw: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
      Upload: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
      ImageIcon: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
      AlertCircle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
      Lock: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
      Unlock: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
      Trophy: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
      Menu: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
      Sparkles: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
      Star: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
      Lightbulb: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5 0-2.2-1.8-4-4-4s-4 1.8-4 4c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
      Pencil: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
      Bell: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
      Calendar: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>,
      Video: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>,
      Settings: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
      Database: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
      Key: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>,
      Clock: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Save: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
    };

    // Sound Effect
    const playSound = (type) => {
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        const now = ctx.currentTime;
        if (type === 'correct') {
          osc.type = 'sine';
          osc.frequency.setValueAtTime(880, now); 
          osc.frequency.exponentialRampToValueAtTime(1760, now + 0.1); 
          gain.gain.setValueAtTime(0.3, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
          osc.start(now);
          osc.stop(now + 0.4);
        } else if (type === 'wrong') {
          osc.type = 'sawtooth';
          osc.frequency.setValueAtTime(150, now);
          osc.frequency.linearRampToValueAtTime(80, now + 0.3);
          gain.gain.setValueAtTime(0.3, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
          osc.start(now);
          osc.stop(now + 0.3);
        } else if (type === 'click') {
          osc.type = 'triangle';
          osc.frequency.setValueAtTime(600, now);
          gain.gain.setValueAtTime(0.05, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
          osc.start(now);
          osc.stop(now + 0.1);
        } else if (type === 'clear') {
          osc.type = 'square';
          osc.frequency.setValueAtTime(523.25, now); 
          osc.frequency.setValueAtTime(659.25, now + 0.1); 
          osc.frequency.setValueAtTime(783.99, now + 0.2); 
          osc.frequency.setValueAtTime(1046.50, now + 0.3); 
          gain.gain.setValueAtTime(0.2, now);
          gain.gain.linearRampToValueAtTime(0, now + 1.5);
          osc.start(now);
          osc.stop(now + 1.5);
        }
      } catch (e) { console.error("Sound Error:", e); }
    };

    // Image Resize
    const resizeImage = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            const MAX_SIZE = 800; 
            if (width > height) {
              if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
            } else {
              if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.onerror = () => reject(new Error("Load failed"));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error("Read failed"));
        reader.readAsDataURL(file);
      });
    };

    const App = () => {
      const [levels, setLevels] = useState([]);
      const [news, setNews] = useState([]);
      const [view, setView] = useState('home'); 
      const [currentLevelId, setCurrentLevelId] = useState(null);
      const [isAdmin, setIsAdmin] = useState(false);
      const [showAdminInput, setShowAdminInput] = useState(false); 
      const [adminPasswordInput, setAdminPasswordInput] = useState('');
      
      // Auth & Firestore Readiness States
      const [isAuthReady, setIsAuthReady] = useState(false);
      const [dbError, setDbError] = useState(false);
      const [authError, setAuthError] = useState(false);
      const [authErrorDetails, setAuthErrorDetails] = useState(''); 

      // 1. Auth Logic
      useEffect(() => {
        if (!window.auth) return;

        const unsubscribe = window.auth.onAuthStateChanged((user) => {
            if (!isAuthReady) {
                setIsAuthReady(true);
            }
        });

        window.AuthFunctions.signInAnonymously(window.auth).catch((error) => {
            console.error("Auth Error Catch:", error);
            if (error.code === 'auth/configuration-not-found' || error.code === 'auth/admin-restricted-operation') {
              setAuthError(true);
              setAuthErrorDetails(error.code);
            }
            setIsAuthReady(true);
        });

        return () => unsubscribe();
      }, []);

      // 2. Firebase Sync
      useEffect(() => {
        if (!window.db || !isAuthReady) return;
        
        const { collection, onSnapshot, query, orderBy } = window.Firestore;
        
        try {
          const qLevels = query(collection(window.db, `artifacts/${appId}/public/data/problems`)); 
          const unsubLevels = onSnapshot(qLevels, (snapshot) => {
            let data = snapshot.docs.map(doc => {
                const d = doc.data();
                return { 
                    id: doc.id, 
                    ...d,
                    markers: d.markersJSON ? JSON.parse(d.markersJSON) : (d.markers || []) 
                };
            });
            data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            
            setLevels(data);
            setDbError(false); 
          }, (error) => {
            console.log("Firestore Error (Levels):", error);
            if (error.code === 'not-found' || error.code === 'permission-denied') {
              setDbError(true);
            }
          });

          const qNews = query(collection(window.db, `artifacts/${appId}/public/data/news`));
          const unsubNews = onSnapshot(qNews, (snapshot) => {
            let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            setNews(data);
          }, (error) => {
             console.log("Firestore Error (News):", error);
          });

          return () => { unsubLevels(); unsubNews(); };
        } catch (e) {
          console.error("Sync Setup Error:", e);
        }
      }, [isAuthReady]);

      if (!window.isFirebaseInitialized || !isAuthReady) {
         if (window.isFirebaseInitialized && !authError && !dbError) {
             return (
                 <div className="flex items-center justify-center min-h-screen bg-[#F9FAFB] bg-grid-pattern">
                    <div className="text-center text-slate-500">
                        <Icons.RotateCcw className="w-8 h-8 mx-auto animate-spin" />
                        <p className="mt-2 font-bold font-hand">接続中...</p>
                    </div>
                 </div>
             );
         }
      }
      
      if (dbError || authError) {
        return (
          <div className="fixed inset-0 bg-slate-900/90 flex items-center justify-center z-50 p-4 text-white">
            <div className="bg-slate-800 p-8 rounded-2xl max-w-lg w-full border-2 border-red-500 shadow-2xl">
              <div className="flex items-center gap-3 mb-6 text-red-400">
                <Icons.AlertCircle size={40} />
                <h1 className="text-2xl font-bold">初期設定が必要です</h1>
              </div>
              <p className="mb-4 text-slate-300">Firebaseコンソールで設定を確認してください。</p>
              <div className="space-y-6">
                {authError && <div className="bg-black/30 p-4 rounded-lg border border-slate-600"><h2 className="text-yellow-400 font-bold flex items-center gap-2 mb-2"><Icons.Key size={20} /> 認証(Auth)エラー ({authErrorDetails})</h2><p className="text-sm text-slate-400">Authenticationの「匿名(Anonymous)」プロバイダを有効にしてください。</p></div>}
                {dbError && <div className="bg-black/30 p-4 rounded-lg border border-slate-600"><h2 className="text-yellow-400 font-bold flex items-center gap-2 mb-2"><Icons.Database size={20} /> データベースエラー</h2><p className="text-sm text-slate-400">Firestore Databaseを作成し、セキュリティルール(テストモード)を設定してください。</p></div>}
              </div>
              <div className="mt-8 text-center">
                <button onClick={() => window.location.reload()} className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full font-bold transition-colors shadow-lg">再読み込み</button>
              </div>
            </div>
          </div>
        );
      }

      const deleteLevel = async (id, e) => {
        e.stopPropagation();
        if (!window.db) return;
        if (window.confirm('本当に削除しますか？')) {
          const { deleteDoc, doc } = window.Firestore;
          await deleteDoc(doc(window.db, `artifacts/${appId}/public/data/problems`, id));
        }
      };

      const handleAdminAuth = (e) => {
        e.preventDefault();
        if (adminPasswordInput === ADMIN_PASSWORD) {
          setIsAdmin(true);
          setShowAdminInput(false);
          setAdminPasswordInput('');
        } else {
          alert('パスワードが違います');
        }
      };

      const HomeView = () => (
        <div className="min-h-screen bg-[#F9FAFB] bg-grid-pattern text-slate-800 pb-32">
          <header className="bg-white border-b-4 border-blue-400 py-4 sticky top-0 z-30 shadow-sm">
            <div className="max-w-6xl mx-auto px-4 md:px-6 flex items-center justify-between">
              <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('home')}>
                <div className="bg-blue-500 text-white p-2 rounded-lg transform rotate-[-3deg] shadow-sm">
                  <Icons.Sparkles size={24} />
                </div>
                <h1 className="text-2xl md:text-3xl font-black tracking-tight text-blue-600 font-hand flex items-center gap-1">
                   脳トレ<br className="md:hidden"/>まちがいさがし
                </h1>
              </div>
              <nav className="flex gap-6 text-base font-bold text-slate-500 font-hand items-center">
                <span onClick={() => setView('news')} className="cursor-pointer hover:text-blue-500 transition-colors border-b-2 border-transparent hover:border-blue-400 flex items-center gap-1">
                  <Icons.Bell size={18} /> おしらせ
                </span>
              </nav>
            </div>
          </header>
          <main className="max-w-6xl mx-auto px-4 md:px-6 py-12">
            <div className="text-center mb-16 relative">
              <div className="absolute top-0 left-10 text-yellow-400 hidden md:block animate-bounce-slow"><Icons.Star size={48} fill="currentColor" /></div>
              <div className="absolute bottom-0 right-10 text-pink-400 hidden md:block animate-pulse"><Icons.Lightbulb size={48} /></div>
              <div className="inline-block bg-yellow-300 px-4 py-1 rounded-full transform rotate-[-2deg] mb-4 pop-shadow">
                <p className="text-slate-800 font-black font-hand text-sm tracking-widest">★ BRAIN TRAINING ★</p>
              </div>
              <h2 className="text-3xl md:text-5xl font-black text-slate-800 mb-6 leading-snug font-hand">
                <span className="bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-cyan-400">頭の体操</span>で今すぐ脳を活性化！<br/>
                楽しく<span className="text-pink-500 inline-block transform hover:scale-110 transition-transform cursor-default">脳</span>を刺激しよう
              </h2>
              <div className="max-w-2xl mx-auto bg-white p-6 rounded-2xl border-2 border-slate-100 shadow-sm relative">
                <div className="absolute -top-3 -left-3 bg-blue-500 text-white p-2 rounded-full transform rotate-[-10deg]"><Icons.Pencil size={20} /></div>
                <p className="text-slate-600 font-bold font-hand text-lg">2つの画像をよ～く見比べて、違うところを見つけてね。</p>
              </div>
              {isAdmin && (
                <div className="mt-10">
                  <button onClick={() => setView('create')} className="bg-pink-500 hover:bg-pink-600 text-white px-8 py-4 rounded-full font-black text-lg shadow-[4px_4px_0px_0px_#9d174d] hover:translate-y-1 transition-all flex items-center gap-3 mx-auto font-hand">
                    <Icons.Plus size={24} strokeWidth={3} /> 新しい問題をつくる！
                  </button>
                </div>
              )}
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-10">
              {levels.map((level, idx) => (
                <div key={level.id} className="group cursor-pointer flex flex-col relative" onClick={() => { setCurrentLevelId(level.id); setView('play'); }}>
                  <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-6 bg-yellow-200/80 rotate-[-2deg] z-10 shadow-sm"></div>
                  <div className="bg-white p-3 pb-5 rounded-2xl border-2 border-slate-200 transition-all duration-200 hover:border-blue-400 hover:-translate-y-1 pop-shadow">
                    <div className="relative aspect-[4/3] bg-slate-100 rounded-xl overflow-hidden mb-4 border border-slate-100">
                      <img src={level.imgOriginal} alt={level.title} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                      <div className="absolute bottom-2 right-2 bg-white/90 backdrop-blur text-blue-600 text-xs font-black px-3 py-1 rounded-full border-2 border-blue-100">{level.markers?.length || 0} ミス</div>
                    </div>
                    <div className="px-1">
                      <h3 className="font-bold text-lg text-slate-800 mb-1 leading-snug font-hand group-hover:text-blue-600 transition-colors line-clamp-1">{level.title}</h3>
                      <div className="mt-3 flex items-center justify-between border-t-2 border-slate-100 pt-3 border-dashed">
                         <span className="text-xs font-bold text-slate-400 flex items-center gap-1"><Icons.Play size={12} fill="currentColor" /> PLAY</span>
                         {isAdmin && (
                            <div className="flex gap-2" onClick={e => e.stopPropagation()}>
                              <button onClick={(e) => deleteLevel(level.id, e)} className="text-slate-400 hover:text-red-500 bg-slate-50 p-1.5 rounded-md hover:bg-red-50 transition-colors"><Icons.Trash2 size={16} /></button>
                            </div>
                         )}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
            {levels.length === 0 && (
              <div className="text-center py-24 bg-white rounded-3xl border-4 border-slate-100 border-dashed">
                <div className="text-slate-300 mb-4"><Icons.ImageIcon size={64} className="mx-auto" /></div>
                <p className="text-slate-400 font-bold font-hand text-xl">まだ問題がありません</p>
              </div>
            )}
            <div className="mt-32 pt-12 border-t-4 border-slate-100 flex flex-col items-center gap-6">
              <div className="flex items-center gap-2 text-slate-300 font-black text-xl tracking-widest font-hand"><Icons.Sparkles size={24} /> 脳トレまちがいさがし</div>
              {isAdmin ? (
                 <button onClick={() => setIsAdmin(false)} className="text-xs font-bold text-white bg-red-400 hover:bg-red-500 px-4 py-2 rounded-full transition-colors flex items-center gap-1 shadow-sm"><Icons.Unlock size={12} /> LOGOUT</button>
              ) : (
                !showAdminInput ? (
                  <button onClick={() => setShowAdminInput(true)} className="text-xs font-bold text-slate-300 hover:text-slate-500 transition-colors flex items-center gap-1"><Icons.Lock size={12} /> ADMIN</button>
                ) : (
                  <form onSubmit={handleAdminAuth} className="flex items-center gap-2 bg-white p-1.5 rounded-lg border-2 border-slate-200 shadow-sm animate-fade-in">
                    <input type="password" value={adminPasswordInput} onChange={(e) => setAdminPasswordInput(e.target.value)} placeholder="Pass" className="px-2 py-1 text-sm outline-none w-24 font-bold text-slate-600 bg-transparent" autoFocus />
                    <button type="submit" className="bg-slate-800 text-white px-3 py-1.5 rounded-md text-xs font-bold hover:bg-slate-700">OK</button>
                  </form>
                )
              )}
              <p className="text-[10px] font-bold text-slate-400">© 2025 脳トレまちがいさがし</p>
            </div>
          </main>
        </div>
      );

      const NewsView = () => {
        const [isEditing, setIsEditing] = useState(false);
        const [newTitle, setNewTitle] = useState('');
        const [newContent, setNewContent] = useState('');
        const [newImage, setNewImage] = useState('');
        const [loading, setLoading] = useState(false);

        const handleFileUpload = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          setLoading(true);
          if (file.type.startsWith('video/')) {
             if (file.size > 2 * 1024 * 1024) { 
               alert("動画ファイルが大きすぎます。2MB以下のファイルをアップロードしてください。");
               setLoading(false);
               return;
             }
             const reader = new FileReader();
             reader.onload = (e) => {
               setNewImage(e.target.result);
               setLoading(false);
             };
             reader.onerror = () => {
                alert("動画の読み込みに失敗しました");
                setLoading(false);
             };
             reader.readAsDataURL(file);
          } else {
             try {
               const resized = await resizeImage(file);
               setNewImage(resized);
             } catch(e) { alert("エラー"); }
             setLoading(false);
          }
        };

        const handlePost = async () => {
          if (!newTitle || !newContent || !window.db) return;
          const { addDoc, collection, serverTimestamp } = window.Firestore;
          const now = new Date();
          const dateStr = `${now.getFullYear()}.${now.getMonth() + 1}.${now.getDate()}`;
          await addDoc(collection(window.db, `artifacts/${appId}/public/data/news`), {
            title: newTitle,
            content: newContent,
            image: newImage,
            date: dateStr,
            createdAt: serverTimestamp()
          });
          setIsEditing(false); setNewTitle(''); setNewContent(''); setNewImage('');
        };

        const handleDelete = async (id) => {
          if (!window.db || !confirm("削除しますか？")) return;
          const { deleteDoc, doc } = window.Firestore;
          await deleteDoc(doc(window.db, `artifacts/${appId}/public/data/news`, id));
        };

        return (
          <div className="min-h-screen bg-[#F9FAFB] bg-grid-pattern text-slate-800">
            <header className="bg-white border-b-4 border-blue-400 py-4 sticky top-0 z-30 shadow-sm">
              <div className="max-w-4xl mx-auto px-4 flex items-center justify-between">
                <div className="flex items-center gap-2 text-blue-600 cursor-pointer" onClick={() => setView('home')}>
                   <Icons.ArrowLeft size={24} />
                   <h1 className="text-xl font-black font-hand">おしらせ一覧</h1>
                </div>
              </div>
            </header>
            <main className="max-w-3xl mx-auto px-4 py-10">
              {isAdmin && !isEditing && (
                <div className="mb-8 text-center">
                  <button onClick={() => setIsEditing(true)} className="bg-pink-500 text-white px-6 py-3 rounded-full font-black shadow-md flex items-center gap-2 mx-auto font-hand"><Icons.Plus size={20} /> 投稿する</button>
                </div>
              )}
              {isEditing && (
                <div className="bg-white p-6 rounded-2xl border-2 border-blue-200 mb-10 shadow-lg">
                   <input type="text" value={newTitle} onChange={e => setNewTitle(e.target.value)} className="w-full p-3 border-2 rounded-lg mb-4 font-bold" placeholder="件名" />
                   <textarea value={newContent} onChange={e => setNewContent(e.target.value)} className="w-full p-3 border-2 rounded-lg mb-4 h-32" placeholder="内容" />
                   <div className="flex gap-4 items-center mb-4">
                     <label className="cursor-pointer bg-slate-100 px-4 py-2 rounded font-bold text-sm"><Icons.Upload className="inline mr-2" size={16}/>画像・動画<input type="file" accept="image/*,video/*" className="hidden" onChange={handleFileUpload}/></label>
                     {newImage && <div className="relative w-16 h-16 bg-slate-100 rounded overflow-hidden border">{newImage.startsWith('data:video') ? <video src={newImage} className="w-full h-full object-cover"/> : <img src={newImage} className="w-full h-full object-cover"/>}</div>}
                   </div>
                   <div className="flex justify-end gap-2">
                     <button onClick={() => setIsEditing(false)} className="px-4 py-2 text-slate-500 font-bold">キャンセル</button>
                     <button onClick={handlePost} className="bg-blue-500 text-white px-6 py-2 rounded-lg font-bold">投稿</button>
                   </div>
                </div>
              )}
              <div className="space-y-8">
                {news.length === 0 ? <div className="text-center py-10 text-slate-400">おしらせはありません</div> : news.map(item => (
                  <article key={item.id} className="bg-white p-6 rounded-2xl border-2 border-slate-100 pop-shadow relative">
                    {isAdmin && <button onClick={() => handleDelete(item.id)} className="absolute top-4 right-4 text-slate-300 hover:text-red-500"><Icons.Trash2 size={18} /></button>}
                    <div className="text-slate-400 text-sm font-bold mb-2 font-hand"><Icons.Calendar size={14} className="inline mr-1"/> {item.date}</div>
                    <h3 className="text-xl font-black text-slate-800 mb-4 pb-2 border-b border-slate-100">{item.title}</h3>
                    <div className="text-slate-600 font-medium whitespace-pre-wrap">{item.content}</div>
                    {item.image && <div className="mt-4 max-w-full rounded-xl border border-slate-100 overflow-hidden inline-block">
                      {item.image.startsWith('data:video') ? <video src={item.image} controls className="max-h-64 bg-black w-full"/> : <img src={item.image} className="max-h-64 object-contain bg-slate-50"/>}
                    </div>}
                  </article>
                ))}
              </div>
            </main>
          </div>
        );
      };

      const PlayView = () => {
        const level = levels.find(l => l.id === currentLevelId);
        const [foundIds, setFoundIds] = useState([]);
        const [mistakes, setMistakes] = useState([]);
        const [isCompleted, setIsCompleted] = useState(false);
        const [time, setTime] = useState(0);
        const imgRef = useRef(null);

        // Timer
        useEffect(() => {
            if (isCompleted) return;
            const timerId = setInterval(() => setSeconds(s => s + 1), 1000);
            return () => clearInterval(timerId);
        }, [isCompleted]);

        const setSeconds = (updater) => {
            setTime(updater);
        };

        const formatTime = (s) => {
          const min = Math.floor(s / 60).toString().padStart(2, '0');
          const sec = (s % 60).toString().padStart(2, '0');
          return `${min}:${sec}`;
        }

        if(!level) return null;

        const handleImageClick = (e) => {
          if (isCompleted) return;
          const rect = imgRef.current.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          const hit = level.markers.find(diff => {
            if (foundIds.includes(diff.id)) return false;
            const radius = diff.radius || 5; 
            const dist = Math.sqrt(Math.pow(diff.x - x, 2) + Math.pow(diff.y - y, 2));
            return dist < radius;
          });

          if (hit) {
            playSound('correct');
            const newFound = [...foundIds, hit.id];
            setFoundIds(newFound);
            if (newFound.length === level.markers.length) {
              setIsCompleted(true);
              playSound('clear');
            }
          } else {
            playSound('wrong');
            const mid = Date.now();
            setMistakes(p => [...p, { id: mid, x, y }]);
            setTimeout(() => setMistakes(p => p.filter(m => m.id !== mid)), 800);
          }
        };

        return (
          <div className="flex flex-col min-h-screen bg-[#F9FAFB] bg-grid-pattern text-slate-800">
            <header className="h-16 bg-white flex items-center justify-between px-4 md:px-8 border-b-4 border-blue-400 sticky top-0 z-30 shadow-sm">
              <button onClick={() => setView('home')} className="text-slate-500 hover:text-blue-600 flex items-center gap-2 font-bold text-sm font-hand bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200"><Icons.ArrowLeft size={20} /> もどる</button>
              <div className="flex gap-4 items-center">
                  <div className="bg-white px-4 py-1 rounded-full border-2 border-slate-200 flex items-center gap-2 font-bold text-slate-500">
                      <Icons.Clock size={18} /> {formatTime(time)}
                  </div>
                  <div className="bg-yellow-100 px-4 py-1 rounded-full border-2 border-yellow-300 flex items-baseline gap-2">
                    <span className="text-xs font-black text-yellow-600 uppercase font-hand">FOUND</span>
                    <span className="text-xl text-blue-600 font-black">{foundIds.length}<span className="text-sm text-slate-400 mx-1">/</span>{level.markers.length}</span>
                  </div>
              </div>
            </header>
            <div className="flex-1 overflow-y-auto pb-20 pt-8 px-4">
              <div className="max-w-6xl mx-auto text-center mb-8">
                <h1 className="text-2xl md:text-4xl font-black text-slate-800 mb-2 font-hand">{level.title}</h1>
                <p className="text-slate-500 font-bold text-sm">2つの画像を見比べて、違うところをタップ！</p>
              </div>
              <div className="flex flex-col md:flex-row gap-8 items-center justify-center">
                <div className="w-full max-w-lg bg-white p-3 rounded-2xl border-2 border-slate-200 pop-shadow">
                  <div className="mb-2 bg-blue-500 text-white text-xs font-black px-3 py-1 rounded-full w-max">見本</div>
                  <div className="relative aspect-square bg-slate-50 rounded-xl overflow-hidden"><img src={level.imgOriginal} className="w-full h-full object-contain" />
                    {level.markers.map(diff => foundIds.includes(diff.id) && <div key={diff.id} className="absolute border-[4px] border-blue-400 rounded-full" style={{left:`${diff.x}%`,top:`${diff.y}%`,width:`${(diff.radius || 5)*2}%`,height:`${(diff.radius || 5)*2}%`,transform:'translate(-50%,-50%)',aspectRatio:'1/1'}} />)}
                  </div>
                </div>
                <div className="w-full max-w-lg bg-white p-3 rounded-2xl border-4 border-pink-300 shadow-xl" onClick={handleImageClick}>
                  <div className="mb-2 bg-pink-500 text-white text-xs font-black px-3 py-1 rounded-full w-max">間違い</div>
                  <div className="relative aspect-square bg-slate-50 rounded-xl overflow-hidden cursor-crosshair">
                    <img ref={imgRef} src={level.imgDiff} className="w-full h-full object-contain" />
                    {level.markers.map(diff => foundIds.includes(diff.id) && <div key={diff.id} className="absolute border-[4px] border-pink-500 rounded-full" style={{left:`${diff.x}%`,top:`${diff.y}%`,width:`${(diff.radius || 5)*2}%`,height:`${(diff.radius || 5)*2}%`,transform:'translate(-50%,-50%)',aspectRatio:'1/1'}}><div className="absolute -top-3 -right-3 bg-pink-500 text-white rounded-full p-1"><Icons.CheckCircle size={16}/></div></div>)}
                    {mistakes.map(m => <div key={m.id} className="absolute text-slate-400" style={{left:`${m.x}%`,top:`${m.y}%`,transform:'translate(-50%,-50%)'}}><Icons.X size={60} className="text-red-500"/></div>)}
                  </div>
                </div>
              </div>
            </div>
            {isCompleted && (
              <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <div className="bg-white p-8 rounded-3xl max-w-sm w-full text-center border-4 border-slate-800">
                  <div className="w-24 h-24 bg-yellow-300 text-slate-900 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-slate-800"><Icons.Trophy size={48} fill="white"/></div>
                  <h3 className="text-3xl font-black text-slate-800 mb-2 font-hand">CLEAR!!</h3>
                  <div className="text-xl font-bold text-blue-600 mb-6">タイム: {formatTime(time)}</div>
                  <button onClick={() => setView('home')} className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-black mt-6">一覧にもどる</button>
                </div>
              </div>
            )}
          </div>
        );
      };

      const CreateView = () => {
        const [title, setTitle] = useState('');
        const [imgOrig, setImgOrig] = useState('');
        const [imgDiff, setImgDiff] = useState('');
        const [diffs, setDiffs] = useState([]);
        const [step, setStep] = useState(1);
        const ref = useRef(null);
        const [dragActive, setDragActive] = useState(false);

        const handleSave = async () => {
          if (!title || !imgOrig || !imgDiff || !window.db) return;
          const { addDoc, collection, serverTimestamp } = window.Firestore;
          // JSON stringify markers for safe storage
          const markersJSON = JSON.stringify(diffs);
          await addDoc(collection(window.db, `artifacts/${appId}/public/data/problems`), {
            title, imgOriginal: imgOrig, imgDiff: imgDiff, markersJSON: markersJSON, createdAt: serverTimestamp()
          });
          setView('home');
        };

        const onImg = async (e, setter) => {
          const f = e.target.files ? e.target.files[0] : null;
          if(f) setter(await resizeImage(f));
        };
        
        const handleDrag = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (e.type === "dragenter" || e.type === "dragover") {
                setDragActive(true);
            } else if (e.type === "dragleave") {
                setDragActive(false);
            }
        };
        
        const handleDrop = async (e, setter) => {
            e.preventDefault();
            e.stopPropagation();
            setDragActive(false);
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                const f = e.dataTransfer.files[0];
                setter(await resizeImage(f));
            }
        }

        return (
          <div className="min-h-screen bg-grid-pattern bg-slate-50 text-slate-800 pb-20">
            <div className="bg-white border-b-2 px-6 py-4 flex justify-between sticky top-0 z-30">
              <h2 className="font-black flex gap-2"><Icons.Edit3 size={24} /> 新しい問題</h2>
              <div className="flex gap-2">
                <button onClick={() => setView('home')} className="px-4 py-2 text-slate-500 font-bold">キャンセル</button>
              </div>
            </div>
            <div className="max-w-4xl mx-auto p-6">
              {step === 1 ? (
                <div className="space-y-6 bg-white p-6 rounded-2xl border-2">
                  <input value={title} onChange={e => setTitle(e.target.value)} className="w-full p-3 border-2 rounded-xl font-bold text-lg" placeholder="タイトル" />
                  <div className="grid gap-4">
                    {/* Original Image Upload */}
                    <div 
                        className={`border-2 border-dashed p-4 rounded-xl text-center transition-colors ${dragActive ? 'border-blue-500 bg-blue-50' : 'border-slate-300'}`}
                        onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={(e) => handleDrop(e, setImgOrig)}
                    >
                      <p className="font-bold text-blue-500 mb-2">正解画像</p>
                      {imgOrig ? <img src={imgOrig} className="h-40 mx-auto object-contain"/> : 
                        <label className="cursor-pointer bg-slate-50 border-2 border-slate-200 hover:border-blue-400 hover:bg-blue-50 px-4 py-3 rounded-xl flex items-center gap-2 text-sm font-bold transition-all w-full justify-center group">
                            <Icons.Upload size={18} className="group-hover:scale-110 transition-transform"/> 画像を選択 / ドロップ
                            <input type="file" accept="image/*" className="hidden" onChange={e => onImg(e, setImgOrig)} />
                        </label>
                      }
                    </div>
                    
                    {/* Difference Image Upload */}
                    <div 
                        className={`border-2 border-dashed p-4 rounded-xl text-center transition-colors ${dragActive ? 'border-pink-500 bg-pink-50' : 'border-slate-300'}`}
                        onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={(e) => handleDrop(e, setImgDiff)}
                    >
                      <p className="font-bold text-pink-500 mb-2">間違い画像</p>
                      {imgDiff ? <img src={imgDiff} className="h-40 mx-auto object-contain"/> : 
                        <label className="cursor-pointer bg-slate-50 border-2 border-slate-200 hover:border-pink-400 hover:bg-pink-50 px-4 py-3 rounded-xl flex items-center gap-2 text-sm font-bold transition-all w-full justify-center group">
                            <Icons.Upload size={18} className="group-hover:scale-110 transition-transform"/> 画像を選択 / ドロップ
                            <input type="file" accept="image/*" className="hidden" onChange={e => onImg(e, setImgDiff)} />
                        </label>
                      }
                    </div>
                  </div>
                  <button onClick={() => setStep(2)} disabled={!imgOrig || !imgDiff} className="w-full bg-blue-500 text-white py-4 rounded-xl font-black disabled:opacity-50">次へ</button>
                </div>
              ) : (
                <div className="text-center">
                  <p className="mb-4 font-bold text-blue-600">間違い箇所をタップして追加 ({diffs.length})</p>
                  <div className="relative inline-block border-4 border-slate-200 rounded-xl overflow-hidden" onClick={e => {
                    const r = ref.current.getBoundingClientRect();
                    const x = ((e.clientX - r.left) / r.width) * 100;
                    const y = ((e.clientY - r.top) / r.height) * 100;
                    // Default radius 5%
                    setDiffs([...diffs, { id: Date.now().toString(), x, y, radius: 5 }]); 
                  }}>
                    <img ref={ref} src={imgDiff} className="max-w-full max-h-[70vh] object-contain" />
                    {diffs.map((d, i) => <div key={d.id} className="absolute border-2 border-pink-500 bg-pink-500/30 rounded-full flex items-center justify-center" style={{left:`${d.x}%`,top:`${d.y}%`,width:'10%',height:'10%',transform:'translate(-50%,-50%)',aspectRatio:'1/1'}}><span className="text-white font-bold drop-shadow-md">{i+1}</span></div>)}
                  </div>
                  <div className="mt-4 flex justify-between items-center">
                     <button onClick={() => setStep(1)} className="px-4 py-2 text-slate-500 font-bold flex items-center gap-1"><Icons.ArrowLeft size={16}/> 戻る</button>
                     <div>
                        <button onClick={() => setDiffs([])} className="px-4 py-2 text-red-500 font-bold flex items-center gap-1 mr-2"><Icons.Trash2 size={16}/> リセット</button>
                        <button onClick={handleSave} className="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-black shadow-[0_4px_0_#15803d] active:translate-y-1 active:shadow-none transition-all inline-flex items-center gap-2">
                            <Icons.Save size={18}/> 保存して公開
                        </button>
                     </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      if (view === 'home') return <HomeView />;
      if (view === 'news') return <NewsView />;
      if (view === 'play') return <PlayView />;
      if (view === 'create') return <CreateView />;
      return null;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
